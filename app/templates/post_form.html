{% extends 'base.html' %}
{% block title %}{{ button_text }}{% endblock %}

{% block content %}
<h1 class="post-form-title">{{ button_text }}</h1>

<div class="post-form">
    <form method="POST" action="{% if post %}{{ url_for('admin.edit_post', id=post.id) }}{% else %}{{ url_for('admin.new_post') }}{% endif %}" id="postForm">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <div class="form-group">
            <label for="title">Başlık:</label>
            <input type="text" id="title" name="title" value="{{ post.title if post else '' }}" required>
        </div>

        <div class="form-group">
            <label for="editor">İçerik:</label>
            <div id="editor" style="height: 400px;">
                {% if post %}
                    {{ post.content|safe }}
                {% endif %}
            </div>
            <input type="hidden" name="content" id="contentInput">
        </div>

        <div class="form-group">
            <label>Kategoriler (maks 3 seçim):</label><br>
            {% for cat in categories %}
                <input type="checkbox" name="categories" value="{{ cat.id }}"
                    {% if post and cat in post.categories %} checked {% endif %}>
                {{ cat.name }}<br>
            {% endfor %}
        </div>

        <button type="submit" class="submit-btn">{{ button_text }}</button>
    </form>
</div>
{% endblock %}

{% block scripts %}
<!-- Quill CSS -->
<link href="https://cdn.quilljs.com/1.3.7/quill.snow.css" rel="stylesheet">
<!-- Quill JS -->
<script src="https://cdn.quilljs.com/1.3.7/quill.min.js"></script>
<!-- Quill Image Resize Module -->
<script src="https://cdn.jsdelivr.net/npm/quill-image-resize-module@3.0.0/image-resize.min.js"></script>

<script>
const csrfToken = '{{ csrf_token() }}';  // CSRF token değişkeni

// Quill editor 
var quill = new Quill('#editor', {
    theme: 'snow',
    modules: {
        toolbar: [
            ['bold', 'italic', 'underline', 'strike'],
            ['link', 'image', 'video'],
            [{ 'list': 'ordered'}, { 'list': 'bullet' }],
            [{ 'align': [] }],
            ['clean']
        ],
        imageResize: {}  // Burada resize module aktifleştirildi
    }
});

// Form submit olunca hidden inputa html koyar
document.getElementById('postForm').onsubmit = function() {
    document.getElementById('contentInput').value = quill.root.innerHTML;
};

// Image upload için handler
function uploadImage(file) {
    const formData = new FormData();
    formData.append('file', file);

    return fetch('{{ url_for("admin.upload_image") }}', {
        method: 'POST',
        headers: { 'X-CSRFToken': csrfToken },
        body: formData
    })
    .then(response => response.json())
    .then(result => {
        if (result.location) return result.location;
        throw new Error('Upload failed');
    });
}

// Quill image handler override
quill.getModule('toolbar').addHandler('image', () => {
    const input = document.createElement('input');
    input.setAttribute('type', 'file');
    input.setAttribute('accept', 'image/*');
    input.click();

    input.onchange = async () => {
        const file = input.files[0];
        if (file) {
            try {
                const url = await uploadImage(file);
                const range = quill.getSelection();
                quill.insertEmbed(range.index, 'image', url);
            } catch (err) {
                alert('Image upload failed: ' + err.message);
            }
        }
    };
});
</script>
{% endblock %}
